<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>QR 扫描器</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <style>
    body{font-family:system-ui;background:#111;color:#0f0;text-align:center;margin:0;padding:1rem}
    #reader{max-width:400px;margin:auto;border:2px solid #0f0}
    button{margin:.5rem;padding:.6rem 1.2rem;font-size:1rem;background:#0f0;color:#000;border:none;border-radius:4px}
    ul{max-height:40vh;overflow:auto;text-align:left}
    li{word-break:break-all}
  </style>
</head>
<body>
  <h2>QR 扫描器</h2>
  <div id="reader"></div>
  <button onclick="exportCSV()">导出 CSV</button>
  <button onclick="clearHis()">清空记录</button>
  <ul id="list"></ul>

  <!-- html5-qrcode CDN -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    /* --------------- 数据 --------------- */
    const get=()=>JSON.parse(localStorage.getItem('qr')||'[]');
    const set=d=>localStorage.setItem('qr',JSON.stringify(d));

    /* --------------- 声音 --------------- */
    const beep=new Audio('data:audio/wav;base64,UklGRlJDAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYZDAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIA');

    /* --------------- 渲染 --------------- */
    function render(){
      document.getElementById('list').innerHTML=
        get().map(e=>`<li>${e.t} - ${e.c}</li>`).join('');
    }

    /* --------------- 导出 --------------- */
    function exportCSV(){
      const rows=get().map(e=>`"${e.t}","${e.c.replace(/"/g,'""')}"`);
      const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='scan.csv';
      a.click();
    }

    /* --------------- 清空 --------------- */
    function clearHis(){if(confirm('清空全部记录？')){set([]);render();}}

    /* --------------- 扫码回调 --------------- */
    function onScan(txt){
      beep.play();
      const d=get(); d.unshift({t:new Date().toLocaleString(),c:txt}); set(d); render();
    }

    /* --------------- 启动 --------------- */
    window.addEventListener('DOMContentLoaded',()=>{
      render();
      const qr=new Html5Qrcode('reader');
      qr.start({facingMode:'environment'},{fps:10},onScan,console.error);
    });
  </script>
</body>
</html>